from enum import Enum
import asyncio
from google import genai
from google.genai import types as genai_types
from config import GEMINI_API_KEY

# Initialize Gemini client
client = genai.Client(api_key=GEMINI_API_KEY)

class GeminiModel(Enum):
    FLASH = "gemini-2.0-flash"
    FLASH_THINKING = "gemini-2.0-flash-thinking-exp-01-21"

async def call_gemini_api(query: str, model: GeminiModel = GeminiModel.FLASH) -> str:
    """Call Gemini API with the given query text and model asynchronously"""
    contents = [
        genai_types.Content(
            role="user",
            parts=[genai_types.Part.from_text(text=query)],
        ),
    ]
    
    generate_content_config = genai_types.GenerateContentConfig(
        temperature=1,
        top_p=0.95,
        top_k=60,
        max_output_tokens=8192,
        response_mime_type="text/plain",
        tools=[
            genai_types.Tool(google_search=genai_types.GoogleSearch())
        ],
        system_instruction=[
            genai_types.Part.from_text(
                text="""**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**  
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** –∞–≤—Ç–æ—Ä –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∞, Kotaz (–ö–æ—Ç–∞–∑).  
- **–°–æ–±–µ—Å–µ–¥–Ω–∏–∫:** –°–æ–±–µ—Å–µ–¥–Ω–∏–∫.

**–†–æ–ª—å:**  
–¢—ã ‚Äî –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Kotaz, –∏–º–µ–Ω—É–µ–º—ã–π ¬´–ì–µ–º–∏–Ω–∏¬ª. –í—ã–ø–æ–ª–Ω—è–µ—à—å —Ä–æ–ª—å —Å–µ–∫—Ä–µ—Ç–∞—Ä—è –∏ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–∞, –æ—Ç–≤–µ—á–∞—é—â–µ–≥–æ –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã –∫–∞–∫ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤, —Ç–∞–∫ –∏ –ø—Ä–∏ –ø—Ä—è–º–æ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ì–µ–º–∏–Ω–∏, —Ä–∞–∑–±–µ—Ä–∏—Å—å¬ª). –î–µ–π—Å—Ç–≤—É–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å, –∏—Å–ø–æ–ª—å–∑—É—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —á–∞—Ç–∞.

–í–æ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –∏ —Å–ø–æ—Å–æ–±–æ–≤ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–∏–∑–Ω–µ—Å-–±–æ—Ç–æ–º:

1. **`!–ì–µ–º–∏–Ω–∏ <—Å–æ–æ–±—â–µ–Ω–∏–µ>`** ‚Äî –ø–æ–º–µ—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –≤–∞–∂–Ω–æ–µ. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å ID `782491733` (–≤–ª–∞–¥–µ–ª—å—Ü—É).  
2. **`–ì–µ–º–∏–Ω–∏, <—Å–æ–æ–±—â–µ–Ω–∏–µ>`** ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–æ–º (–±–µ–∑ –º–µ—Ç–∫–∏ –≤–∞–∂–Ω–æ—Å—Ç–∏).  
3. **`!–î–µ–±–∞–≥`** ‚Äî –≤—ã–≤–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É.  
4. **`!–¥—É–º–∞–π` –≤ —Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞** ‚Äî –≤–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –±–æ–ª–µ–µ ¬´–≤–¥—É–º—á–∏–≤–æ–≥–æ¬ª –∞–Ω–∞–ª–∏–∑–∞ (`GeminiModel.FLASH_THINKING`).  

–ë–æ—Ç —Ç–∞–∫–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è** –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ—ë –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤.

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:**  
- –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, —á—ë—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π, –µ—Å–ª–∏ –Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–æ –∏–Ω–æ–µ.  
- –ü—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–æ–Ω–∞, –Ω–æ –º–æ–∂–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ, –ø–µ—Ä–µ—Ö–æ–¥—è —Å—Ä–∞–∑—É –∫ —Å—É—Ç–∏.  
- –£—á–∏—Ç—ã–≤–∞–π –±—É–¥—É—â–µ–µ –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É, –æ—Å—Ç–∞–≤–∞—è—Å—å —Å–∫–µ–ø—Ç–∏—á–Ω—ã–º –∫ –ø—Ä–∏–Ω—è—Ç—ã–º —Ä–µ—à–µ–Ω–∏—è–º –∏ –ø–æ–¥—Ö–æ–¥–∞–º.  
- –û–±—â–∞–π—Å—è –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –æ–±—ã—á–Ω–æ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ª—é–¥–∏ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö. –ù–æ —Å–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º –∏ —É–≤–∞–∂–µ–Ω–∏–µ.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ—á–µ–Ω—å –∫–ª–∏—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–¥–∞–µ—Ç –≤ —Ç–µ–±–µ –∏—Å–∫—É—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç. –°—Ç–∞—Ä–∞–π—Å—è –≤–µ—Å—Ç–∏ —Å–µ–±—è –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–¥–∞ –∏–ª–∏ —Å–ª–æ–∂–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π), –æ—Ç–≤–µ—á–∞–π —Å–∂–∞—Ç–æ,–∫—Ä–∞—Ç–∫–æ, –±–µ–∑ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤."""
            ),
        ],
    )
    
    # Run the API call in a thread to avoid blocking
    loop = asyncio.get_event_loop()
    result = await loop.run_in_executor(
        None,
        lambda: client.models.generate_content(
            model=model.value,
            contents=contents,
            config=generate_content_config,
        )
    )
    
    if model == GeminiModel.FLASH_THINKING:
        return "üé©" + result.text
    return result.text
